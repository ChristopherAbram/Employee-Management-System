CREATE TABLE IF NOT EXISTS country (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
   	`name`		VARCHAR(128) NOT NULL,
	`short`		VARCHAR(5)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS user_role (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`access_level`	TINYINT(1) NOT NULL DEFAULT 0,
	`name`		VARCHAR(32) NOT NULL
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS user (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
        `email` 	VARCHAR(100) NOT NULL,
	`password` 	VARCHAR(40) NOT NULL,
	`firstname` 	VARCHAR(100) NOT NULL,
	`lastname` 	VARCHAR(100) NOT NULL,
   	`phone` 	VARCHAR(20),
	`user_role_id`	INT(11) UNSIGNED NULL,
   	`firstaccess` 	BIGINT(10),
   	`lastaccess` 	BIGINT(10),
   	`lastlogin` 	BIGINT(10),
   	`avatar` 	INT(11) UNSIGNED,
	`sex`		ENUM('F', 'M') NOT NULL,
	`cdate` 	DATETIME,
	`bdate`		DATE,
	`description` 	TEXT,
	`citation`	VARCHAR(255),
	`isactive` 	TINYINT(1) DEFAULT 0,
	`bin`		TINYINT(1) DEFAULT 0,
	`token` 	VARCHAR(40) NOT NULL,
	
	CONSTRAINT `user_user_role_fk` FOREIGN KEY (`user_role_id`) REFERENCES `user_role`(`id`) ON DELETE SET NULL,
  	UNIQUE KEY  `usersKEY` ( `email` )

) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS address (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`country_id`	INT(11) UNSIGNED NULL,
	`user_id`	INT(11) UNSIGNED NOT NULL,
   	`city`		VARCHAR(128) NOT NULL,
	`zip`		VARCHAR(10),
	`street`	VARCHAR(128) NOT NULL,
	`house`		VARCHAR(16) NOT NULL,
	`flat`		VARCHAR(16),

	CONSTRAINT `address_user_fk` FOREIGN KEY (`user_id`) REFERENCES user(id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT `address_country_fk` FOREIGN KEY (`country_id`) REFERENCES country(id) ON DELETE SET NULL

) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS file_info (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  	`name`		VARCHAR(255) NOT NULL,
  	`description` 	TEXT,
  	`size`		INT(10) UNSIGNED DEFAULT 0,
  	`mtime`		INT(10) UNSIGNED,
  	`cdate`     	DATETIME DEFAULT NULL,
  	`mime`      	VARCHAR(255) DEFAULT 'unknown',
  	`read`      	TINYINT(1) DEFAULT 1,
  	`write`     	TINYINT(1) DEFAULT 1,
  	`locked`    	TINYINT(1) DEFAULT 0,
  	`hide`    	TINYINT(1) DEFAULT 0,
	`bin`	      	TINYINT(1) DEFAULT 0,
  	`width`     	INT(5) DEFAULT 0,
  	`height`	INT(5) DEFAULT 0,
	`extension`  	VARCHAR(8) DEFAULT 'unknown',
  	`user_id`	INT(11) UNSIGNED NOT NULL,

	CONSTRAINT `file_info_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE user ADD CONSTRAINT `user_file_info_fk` FOREIGN KEY (`avatar`) REFERENCES `file_info`(`id`) ON DELETE SET NULL;

CREATE TABLE IF NOT EXISTS file (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`file_info_id`	INT(11) UNSIGNED NOT NULL,
	`content`	LONGBLOB NOT NULL,
	
        UNIQUE (`file_info_id`),
	CONSTRAINT `file_file_info_fk` FOREIGN KEY (`file_info_id`) REFERENCES `file_info`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS file_miniature (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`file_info_id`	INT(11) UNSIGNED NOT NULL,
	`content`	BLOB NOT NULL,
	
        UNIQUE (`file_info_id`),
	CONSTRAINT `file_miniature_file_info_fk` FOREIGN KEY (`file_info_id`) REFERENCES `file_info`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS `page` (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
   	`link`		TEXT,
   	`namepath` 	VARCHAR(255),
	`title`		TEXT,
   	`body`		LONGTEXT,
	`description` 	TEXT,
	`keywords`	TEXT,
   	`page_id`	INT(11) UNSIGNED NULL,
   	`ord`		INT(3) DEFAULT 0,
   	`bin`	 	TINYINT(1) DEFAULT 0,
   	`hide` 		TINYINT(1) DEFAULT 0,
   	`mark` 		TINYINT(1) DEFAULT 0,
   	`visits`	INT(11) DEFAULT 0,
   	`cdate`		DATETIME DEFAULT NULL,
   	`edate` 	DATETIME DEFAULT NULL,
   	`user_id`	INT(11) UNSIGNED NULL,
	`vars`		TEXT,
	
	CONSTRAINT `page_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL,
	CONSTRAINT `page_page_fk` FOREIGN KEY (`page_id`) REFERENCES `page`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
   	UNIQUE KEY `namepath` (`namepath`)

) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;

INSERT INTO page(id, namepath, title) VALUES(1, 'root', 'ROOT PAGE');
ALTER TABLE page MODIFY COLUMN page_id INT(11) UNSIGNED DEFAULT 1;

CREATE TABLE IF NOT EXISTS page_visit (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`user_id`	INT(11) UNSIGNED NULL,
  	`page_id`	INT(11) UNSIGNED NOT NULL,
	`cdate`		DATETIME,
	
	CONSTRAINT `page_visit_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL,
	CONSTRAINT `page_visit_page_fk` FOREIGN KEY (`page_id`) REFERENCES `page`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS user_page (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`user_id`	INT(11) UNSIGNED NOT NULL,
  	`page_id`	INT(11) UNSIGNED NOT NULL,
	
	CONSTRAINT `user_page_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT `user_page_page_fk` FOREIGN KEY (`page_id`) REFERENCES `page`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS article (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
   	`link`		TEXT,
   	`namepath` 	VARCHAR(255),
	`title`		TEXT,
   	`body`		LONGTEXT,
	`description` 	TEXT,
	`keywords`	TEXT,
        `file_id`       INT(11) UNSIGNED INT NULL,
   	`page_id`	INT(11) UNSIGNED NOT NULL,
   	`ord`		INT(3) DEFAULT 0,
   	`bin`	 	TINYINT(1) DEFAULT 0,
   	`hide` 		TINYINT(1) DEFAULT 0,
   	`mark` 		TINYINT(1) DEFAULT 0,
   	`cdate`		DATETIME DEFAULT NULL,
   	`edate` 	DATETIME DEFAULT NULL,
   	`user_id`	INT(11) UNSIGNED NULL,
	`vars`		TEXT,
	
	CONSTRAINT `article_page_fk` FOREIGN KEY (`page_id`) REFERENCES `page`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT `article_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL,
        CONSTRAINT `article_file_info_fk` FOREIGN KEY (`file_id`) REFERENCES `file_info`(`id`) ON DELETE SET NULL ON UPDATE CASCADE,
   	UNIQUE KEY `namepath` (`namepath`)
	
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;

CREATE TABLE IF NOT EXISTS article_visit (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`user_id`	INT(11) UNSIGNED NULL,
  	`article_id`	INT(11) UNSIGNED NOT NULL,
	`cdate`		DATETIME,
	
	CONSTRAINT `article_visit_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL,
	CONSTRAINT `article_visit_article_fk` FOREIGN KEY (`article_id`) REFERENCES `article`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS mark (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`user_id`	INT(11) UNSIGNED NULL,
  	`article_id`	INT(11) UNSIGNED NOT NULL,
	`value`         TINYINT(1) DEFAULT 1 CHECK(`value` >= 1 AND `value` <= 5),
	`cdate`		DATETIME,
	
	CONSTRAINT `mark_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL,
	CONSTRAINT `mark_article_fk` FOREIGN KEY (`article_id`) REFERENCES `article`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE IF NOT EXISTS comment (
	`id`		INT(11) UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`user_id`	INT(11) UNSIGNED NOT NULL,
  	`article_id`	INT(11) UNSIGNED NOT NULL,
	`content`	TEXT,
	`cdate`		DATETIME,
	`bin`		TINYINT(1) DEFAULT 0,
	`hide`		TINYINT(1) DEFAULT 0,
	
	CONSTRAINT `comment_user_fk` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT `comment_article_fk` FOREIGN KEY (`article_id`) REFERENCES `article`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
	
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;